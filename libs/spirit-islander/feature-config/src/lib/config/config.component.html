<main ui-page>
  <!-- <ng-container ui-page-content>
    {{ form.errors | json }}
  </ng-container> -->
  <form *ngIf="config"
    class="config"
    ui-page-content
    [formGroup]="form"
    (ngSubmit)="onSubmit()"
  >
    <ui-card-group
      name="You"
      description="What are you playing with?"
    >
      <ui-card name="expansions">
        <core-checkbox-tree
          formControlName="expansions"
          [getId]="getId"
          [getChildren]="getChildren"
          [tree]="expansionsTree"
          [template]="checkboxTemplate"
          (nodeClick)="onExpansionChange($event)"
        ></core-checkbox-tree>
      </ui-card>

      <ui-card name="players"
        [error]="form.errors?.['playersOutnumberTotalBoards']"
      >
        <h3 ui-card-header>
          Players
        </h3>
        <div ui-card-content>{{ form.get('players')?.value }}</div>
      </ui-card>

      <ui-card name="difficulty"
        [error]="form.errors?.['invalidDifficultyRange']"
      >
        <h3 ui-card-header>
          Difficulty
        </h3>
        <div ui-card-content>{{ form.get('difficultyRange')?.value | json }}</div>
      </ui-card>
    </ui-card-group>

    <ui-card-group
      name="The Game"
      description="What are you open to playing with?"
    >
      <ui-card name="spirits"
        [error]="form.errors?.['playersOutnumberSpirits']"
      >
        <core-checkbox-tree
          formControlName="spirits"
          [getId]="getId"
          [getChildren]="getChildren"
          [tree]="spiritsTree"
          [template]="checkboxTemplate"
        ></core-checkbox-tree>
      </ui-card>

      <ui-card name="maps"
        [error]="form.get('maps')?.errors?.['required']"
      >
        <core-checkbox-tree
          formControlName="maps"
          [getId]="getId"
          [getChildren]="getChildren"
          [tree]="mapsTree"
          [template]="checkboxTemplate"
        ></core-checkbox-tree>
      </ui-card>

      <ui-card name="boards"
        [error]="form.errors?.['playersOutnumberSelectedBoards']"
      >
        <core-checkbox-tree
          formControlName="boards"
          [getId]="getId"
          [getChildren]="getChildren"
          [tree]="boardsTree"
          [template]="checkboxTemplate"
        ></core-checkbox-tree>
      </ui-card>

      <ui-card name="scenarios"
        [error]="form.get('scenarios')?.errors?.['required']"
      >
        <core-checkbox-tree
          formControlName="scenarios"
          [getId]="getId"
          [getChildren]="getChildren"
          [tree]="scenariosTree"
          [template]="checkboxTemplate"
        ></core-checkbox-tree>
      </ui-card>

      <ui-card name="adversaries"
        [error]="form.get('adversaries')?.errors?.['required']"
      >
        <core-checkbox-tree
          formControlName="adversaries"
          [getId]="getId"
          [getChildren]="getChildren"
          [tree]="adversariesTree"
          [template]="checkboxTemplate"
        ></core-checkbox-tree>
      </ui-card>
    </ui-card-group>

    <div ui-page-actions>
      <button core-button
        [disabled]="!form.valid"
      >
        Generate
      </button>
    </div>
  </form>
</main>

<ng-template #checkboxTemplate
  let-item
  let-level="level"
  let-checked="checked"
  let-indeterminate="indeterminate"
  let-onChange="onChange"
>
  <core-checkbox ui-card-header
    *ngIf="level === 0"
    [indeterminate]="indeterminate"
    size="normal"
    [ngModel]="checked"
    (ngModelChange)="onChange($event, item)"
  >
    {{ item.display?.name ?? item.id }}
  </core-checkbox>

  <core-checkbox class="checkbox"
    *ngIf="level > 0"
    [style.margin-left.px]="(level - 1) * 24"
    [indeterminate]="indeterminate"
    size="normal"
    [ngModel]="checked"
    (ngModelChange)="onChange($event, item)"
  >
    {{ item.display?.name ?? item.id }}
    <ui-difficulty-emblem
      *ngIf="item.display?.difficulty"
      [value]="item.display.difficulty"
    ></ui-difficulty-emblem>
    <ui-expansion-emblem
      *ngIf="item.display?.expansion"
      [value]="item.display.expansion"
    ></ui-expansion-emblem>
  </core-checkbox>
</ng-template>
